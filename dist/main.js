(()=>{var Z=(e,t)=>()=>(e&&(t=e(e=0)),t);async function G(e,t,r){let n=await fetch(e,t),i=0,s=Number(n.headers.get("Content-Length"))||0;return(!Number.isInteger(s)||!Number.isFinite(s)||s<=0)&&(s=null),new Response(new ReadableStream({async start(o){let a=n.body.getReader();for(;;){let{done:l,value:u}=await a.read();if(l){r(i,s,!0);break}i+=u.byteLength,r(i,s,!1),o.enqueue(u)}o.close()}}),{status:n.status,statusText:n.statusText,headers:n.headers})}function v(e,t){let r=new URL(e,location.href);r.search="";for(let[n,i]of Object.entries(t))n==="open"&&i.startsWith("/")&&(i=i.substr(1)),r.searchParams.set(n,i);return r.search=decodeURIComponent(r.search),r.toString()}function Q(e){let t=[];if(!FS.analyzePath(e).exists)return t;function r(n){for(let i of FS.readdir(n)){if(i==="."||i==="..")continue;let s=`${n}/${i}`,{mode:o,timestamp:a}=FS.lookupPath(s).node;FS.isFile(o)?t.push({path:s,timestamp:a}):FS.isDir(o)&&r(s)}}return r(e),t}function S(e,t,r){let n=document.createElement(e);return t&&(n.className=t),n.textContent=r,n}function L(e,t,r){let n=e||t,i=1,s=0;return r===void 0&&(n>1024**2?r="MB":n>1024?r="KB":r="B"),r==="B"?(i=1,s=0):r==="KB"?(i=1024,s=0):r==="MB"&&(i=1024**2,s=1),t===void 0?`${(e/i).toFixed(s)} ${r}`:`${(e/i).toFixed(s)}/${(t/i).toFixed(s)} ${r}`}var Y,P=Z(()=>{Y=async e=>{let t=[];async function r(i){for await(let s of i.values())t.push(s),s.kind==="directory"&&await r(s)}await r(e);let n=new Map;n.set(".",e);for(let i of t){let s=(await e.resolve(i)).join("/");n.set(s,i)}return n}});var be={};function Ee(e,t){return Object.assign(e,t)}var V,X=Z(()=>{P();V={library:{}};Ee(V.library,{$FSFS__deps:["$FS","$MEMFS","$PATH"],$FSFS__postset:function(){return""},$FSFS:{DIR_MODE:16895,FILE_MODE:33279,mount:function(e){if(!e.opts.dirHandle)throw new Error("opts.dirHandle is required");return MEMFS.mount.apply(null,arguments)},syncfs:async(e,t,r)=>{try{let n=await FSFS.getLocalSet(e),i=await FSFS.getRemoteSet(e),s=t?i:n,o=t?n:i;await FSFS.reconcile(e,s,o),r(null)}catch(n){r(n)}},getLocalSet:e=>{var t=Object.create(null);function r(a){return a!=="."&&a!==".."}function n(a){return l=>PATH.join2(a,l)}for(var i=FS.readdir(e.mountpoint).filter(r).map(n(e.mountpoint));i.length;){var s=i.pop(),o=FS.stat(s);FS.isDir(o.mode)&&i.push.apply(i,FS.readdir(s).filter(r).map(n(s))),t[s]={timestamp:o.mtime,mode:o.mode}}return{type:"local",entries:t}},getRemoteSet:async e=>{let t=Object.create(null),r=await Y(e.opts.dirHandle,!0);for(let[n,i]of r)n!=="."&&(t[PATH.join2(e.mountpoint,n)]={timestamp:i.kind==="file"?(await i.getFile()).lastModifiedDate:new Date,mode:i.kind==="file"?FSFS.FILE_MODE:FSFS.DIR_MODE});return{type:"remote",entries:t,handles:r}},loadLocalEntry:e=>{let r=FS.lookupPath(e).node,n=FS.stat(e);if(FS.isDir(n.mode))return{timestamp:n.mtime,mode:n.mode};if(FS.isFile(n.mode))return r.contents=MEMFS.getFileDataAsTypedArray(r),{timestamp:n.mtime,mode:n.mode,contents:r.contents};throw new Error("node type not supported")},storeLocalEntry:(e,t)=>{if(FS.isDir(t.mode))FS.mkdirTree(e,t.mode);else if(FS.isFile(t.mode))FS.writeFile(e,t.contents,{canOwn:!0});else throw new Error("node type not supported");FS.chmod(e,t.mode),FS.utime(e,t.timestamp,t.timestamp)},removeLocalEntry:e=>{var t=FS.stat(e);FS.isDir(t.mode)?FS.rmdir(e):FS.isFile(t.mode)&&FS.unlink(e)},loadRemoteEntry:async e=>{if(e.kind==="file"){let t=await e.getFile();return{contents:new Uint8Array(await t.arrayBuffer()),mode:FSFS.FILE_MODE,timestamp:t.lastModifiedDate}}else{if(e.kind==="directory")return{mode:FSFS.DIR_MODE,timestamp:new Date};throw new Error("unknown kind: "+e.kind)}},storeRemoteEntry:async(e,t,r)=>{let n=e.get(PATH.dirname(t)),i=FS.isFile(r.mode)?await n.getFileHandle(PATH.basename(t),{create:!0}):await n.getDirectoryHandle(PATH.basename(t),{create:!0});if(i.kind==="file"){let s=await i.createWritable();await s.write(r.contents),await s.close()}e.set(t,i)},removeRemoteEntry:async(e,t)=>{await e.get(PATH.dirname(t)).removeEntry(PATH.basename(t)),e.delete(t)},reconcile:async(e,t,r)=>{let n=0,i=[];Object.keys(t.entries).forEach(function(a){let l=t.entries[a],u=r.entries[a];(!u||FS.isFile(l.mode)&&l.timestamp.getTime()>u.timestamp.getTime())&&(i.push(a),n++)}),i.sort();let s=[];if(Object.keys(r.entries).forEach(function(a){t.entries[a]||(s.push(a),n++)}),s.sort().reverse(),!n)return;let o=t.type==="remote"?t.handles:r.handles;for(let a of i){let l=PATH.normalize(a.replace(e.mountpoint,"/")).substring(1);if(r.type==="local"){let u=o.get(l),c=await FSFS.loadRemoteEntry(u);FSFS.storeLocalEntry(a,c)}else{let u=FSFS.loadLocalEntry(a);await FSFS.storeRemoteEntry(o,l,u)}}for(let a of s)if(r.type==="local")FSFS.removeLocalEntry(a);else{let l=PATH.normalize(a.replace(e.mountpoint,"/")).substring(1);await FSFS.removeRemoteEntry(o,l)}}}});globalThis.FSFS=V.library.$FSFS;FS.filesystems.FSFS=FSFS});var R=(()=>{if(typeof self>"u")return!1;if("top"in self&&self!==top)try{top.window.document._=0}catch{return!1}return"showOpenFilePicker"in self})(),ie=R?Promise.resolve().then(function(){return le}):Promise.resolve().then(function(){return ye});async function j(...e){return(await ie).default(...e)}var oe=R?Promise.resolve().then(function(){return de}):Promise.resolve().then(function(){return ge});async function B(...e){return(await oe).default(...e)}var se=R?Promise.resolve().then(function(){return me}):Promise.resolve().then(function(){return Se});async function N(...e){return(await se).default(...e)}var ae=async e=>{let t=await e.getFile();return t.handle=e,t},ce=async(e=[{}])=>{Array.isArray(e)||(e=[e]);let t=[];e.forEach((i,s)=>{t[s]={description:i.description||"Files",accept:{}},i.mimeTypes?i.mimeTypes.map(o=>{t[s].accept[o]=i.extensions||[]}):t[s].accept["*/*"]=i.extensions||[]});let r=await window.showOpenFilePicker({id:e[0].id,startIn:e[0].startIn,types:t,multiple:e[0].multiple||!1,excludeAcceptAllOption:e[0].excludeAcceptAllOption||!1}),n=await Promise.all(r.map(ae));return e[0].multiple?n:n[0]},le={__proto__:null,default:ce};function F(e){function t(r){if(Object(r)!==r)return Promise.reject(new TypeError(r+" is not an object."));var n=r.done;return Promise.resolve(r.value).then(function(i){return{value:i,done:n}})}return F=function(r){this.s=r,this.n=r.next},F.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(r){var n=this.s.return;return n===void 0?Promise.resolve({value:r,done:!0}):t(n.apply(this.s,arguments))},throw:function(r){var n=this.s.return;return n===void 0?Promise.reject(r):t(n.apply(this.s,arguments))}},new F(e)}var W=async(e,t,r=e.name,n)=>{let i=[],s=[];var o,a=!1,l=!1;try{for(var u,c=function(d){var f,m,y,w=2;for(typeof Symbol<"u"&&(m=Symbol.asyncIterator,y=Symbol.iterator);w--;){if(m&&(f=d[m])!=null)return f.call(d);if(y&&(f=d[y])!=null)return new F(f.call(d));m="@@asyncIterator",y="@@iterator"}throw new TypeError("Object is not async iterable")}(e.values());a=!(u=await c.next()).done;a=!1){let d=u.value,f=`${r}/${d.name}`;d.kind==="file"?s.push(d.getFile().then(m=>(m.directoryHandle=e,m.handle=d,Object.defineProperty(m,"webkitRelativePath",{configurable:!0,enumerable:!0,get:()=>f})))):d.kind!=="directory"||!t||n&&n(d)||i.push(W(d,t,f,n))}}catch(d){l=!0,o=d}finally{try{a&&c.return!=null&&await c.return()}finally{if(l)throw o}}return[...(await Promise.all(i)).flat(),...await Promise.all(s)]},ue=async(e={})=>{e.recursive=e.recursive||!1,e.mode=e.mode||"read";let t=await window.showDirectoryPicker({id:e.id,startIn:e.startIn,mode:e.mode});return(await(await t.values()).next()).done?[t]:W(t,e.recursive,void 0,e.skipDirectory)},de={__proto__:null,default:ue},fe=async(e,t=[{}],r=null,n=!1,i=null)=>{Array.isArray(t)||(t=[t]),t[0].fileName=t[0].fileName||"Untitled";let s=[],o=null;if(e instanceof Blob&&e.type?o=e.type:e.headers&&e.headers.get("content-type")&&(o=e.headers.get("content-type")),t.forEach((u,c)=>{s[c]={description:u.description||"Files",accept:{}},u.mimeTypes?(c===0&&o&&u.mimeTypes.push(o),u.mimeTypes.map(d=>{s[c].accept[d]=u.extensions||[]})):o?s[c].accept[o]=u.extensions||[]:s[c].accept["*/*"]=u.extensions||[]}),r)try{await r.getFile()}catch(u){if(r=null,n)throw u}let a=r||await window.showSaveFilePicker({suggestedName:t[0].fileName,id:t[0].id,startIn:t[0].startIn,types:s,excludeAcceptAllOption:t[0].excludeAcceptAllOption||!1});!r&&i&&i(a);let l=await a.createWritable();return"stream"in e?(await e.stream().pipeTo(l),a):"body"in e?(await e.body.pipeTo(l),a):(await l.write(await e),await l.close(),a)},me={__proto__:null,default:fe},pe=async(e=[{}])=>(Array.isArray(e)||(e=[e]),new Promise((t,r)=>{let n=document.createElement("input");n.type="file";let i=[...e.map(l=>l.mimeTypes||[]),...e.map(l=>l.extensions||[])].join();n.multiple=e[0].multiple||!1,n.accept=i||"",n.style.display="none",document.body.append(n);let s=l=>{typeof o=="function"&&o(),t(l)},o=e[0].legacySetup&&e[0].legacySetup(s,()=>o(r),n),a=()=>{window.removeEventListener("focus",a),n.remove()};n.addEventListener("click",()=>{window.addEventListener("focus",a)}),n.addEventListener("change",()=>{window.removeEventListener("focus",a),n.remove(),s(n.multiple?Array.from(n.files):n.files[0])}),"showPicker"in HTMLInputElement.prototype?n.showPicker():n.click()})),ye={__proto__:null,default:pe},he=async(e=[{}])=>(Array.isArray(e)||(e=[e]),e[0].recursive=e[0].recursive||!1,new Promise((t,r)=>{let n=document.createElement("input");n.type="file",n.webkitdirectory=!0;let i=o=>{typeof s=="function"&&s(),t(o)},s=e[0].legacySetup&&e[0].legacySetup(i,()=>s(r),n);n.addEventListener("change",()=>{let o=Array.from(n.files);e[0].recursive?e[0].recursive&&e[0].skipDirectory&&(o=o.filter(a=>a.webkitRelativePath.split("/").every(l=>!e[0].skipDirectory({name:l,kind:"directory"})))):o=o.filter(a=>a.webkitRelativePath.split("/").length===2),i(o)}),"showPicker"in HTMLInputElement.prototype?n.showPicker():n.click()})),ge={__proto__:null,default:he},we=async(e,t={})=>{Array.isArray(t)&&(t=t[0]);let r=document.createElement("a"),n=e;"body"in e&&(n=await async function(o,a){let l=o.getReader(),u=new ReadableStream({start:f=>async function m(){return l.read().then(({done:y,value:w})=>{if(!y)return f.enqueue(w),m();f.close()})}()}),c=new Response(u),d=await c.blob();return l.releaseLock(),new Blob([d],{type:a})}(e.body,e.headers.get("content-type"))),r.download=t.fileName||"Untitled",r.href=URL.createObjectURL(await n);let i=()=>{typeof s=="function"&&s()},s=t.legacySetup&&t.legacySetup(i,()=>s(),r);return r.addEventListener("click",()=>{setTimeout(()=>URL.revokeObjectURL(r.href),3e4),i()}),r.click(),null},Se={__proto__:null,default:we};function E(e){return new Promise((t,r)=>{e.oncomplete=e.onsuccess=()=>t(e.result),e.onabort=e.onerror=()=>r(e.error)})}function ve(e,t){let r=indexedDB.open(e);r.onupgradeneeded=()=>r.result.createObjectStore(t);let n=E(r);return(i,s)=>n.then(o=>s(o.transaction(t,i).objectStore(t)))}var D;function O(){return D||(D=ve("keyval-store","keyval")),D}function H(e,t=O()){return t("readonly",r=>E(r.get(e)))}function b(e,t,r=O()){return r("readwrite",n=>(n.put(t,e),E(n.transaction)))}function K(e,t=O()){return t("readwrite",r=>(r.delete(e),E(r.transaction)))}P();var p=null;function J(){return p}var ee,Le=new Promise(e=>{ee=e});async function k(){let e=new URLSearchParams(location.search).get("storage");e!=="fs"&&e!=="idb"&&(e=void 0),e===void 0&&(p=await H("attached-dir"),!self.showDirectoryPicker||p===!1||!await Pe()?(e="idb",p=null):e="fs"),FS.mkdirTree("/local"),e==="fs"?await I(p):FS.mount(IDBFS,{},"/local"),await ZC.fsSync(!0),FS.analyzePath("/local/zc.cfg").exists||FS.writeFile("/local/zc.cfg",FS.readFile("/zc_web.cfg")),FS.analyzePath("/local/zquest.cfg").exists||FS.writeFile("/local/zquest.cfg",FS.readFile("/zquest_web.cfg")),await q(),ee()}async function Pe(){let e={mode:"readwrite"};if(p){if(await p.queryPermission(e)==="granted")return!0;try{return await p.requestPermission(e)==="granted"}catch{}}document.querySelector(".content").classList.add("hidden"),document.querySelector(".permission").classList.remove("hidden"),document.querySelector(".permission .folder-name").textContent=p?.name,document.querySelector(".permission .already-attached").classList.toggle("hidden",!p),document.querySelector(".permission .not-attached").classList.toggle("hidden",!!p);let t=await new Promise(r=>{document.querySelector(".permission .ok").addEventListener("click",()=>{r(!0)}),document.querySelector(".permission .cancel").addEventListener("click",()=>{b("attached-dir",!1),r(!1)})});if(t&&!p)try{p=await self.showDirectoryPicker({id:"zc"})}catch{}return t&&p&&(t=await p.requestPermission(e)==="granted"),document.querySelector(".content").classList.remove("hidden"),document.querySelector(".permission").classList.add("hidden"),t}async function I(e){try{FS.unmount("/local")}catch{}p=e,e?await b("attached-dir",e):await K("attached-dir"),e&&(await Promise.resolve().then(()=>(X(),be)),FS.mount(FSFS,{dirHandle:p},"/local"),await new Promise((t,r)=>FS.syncfs(!0,n=>{if(n)return r(n);t()})))}function te(){let e=document.querySelector(".settings");e.querySelector(".settings__browser-files").addEventListener("click",async i=>{let s=i.target.closest("[data-path]");if(!s)return;let o=s.getAttribute("data-path"),a=new Blob([FS.readFile(o)]);await N(a,{fileName:o.replace("/local/","")})});let r=["zc.cfg","zquest.cfg","zc.sav"];async function n(i){await Le;for(let s of i){let o;s.webkitRelativePath?o=[...PATH.dirname(s.webkitRelativePath).split("/").slice(1),PATH.basename(s.webkitRelativePath)].join("/"):o=s.name;let a="/local/"+o;if(FS.analyzePath(a).exists){let l="/local/.backup/"+o;FS.mkdirTree(PATH.dirname(l)),FS.writeFile(l,FS.readFile(a))}FS.mkdirTree(PATH.dirname(a)),FS.writeFile(a,new Uint8Array(await s.arrayBuffer()))}await ZC.fsSync(!1),i.some(s=>r.includes(s.name))&&window.location.reload(),await q()}e.querySelector(".settings__copy button.copy-folder").addEventListener("click",async()=>{let i=await B({recursive:!0});await n(i)}),e.querySelector(".settings__copy button.copy-file").addEventListener("click",async()=>{let i=await j();await n([i])}),e.querySelector(".settings__attach button.attach").addEventListener("click",async()=>{let i=await self.showDirectoryPicker({id:"zc"});await I(i),window.location.reload()}),e.querySelector(".settings__attach button.unattach").addEventListener("click",async()=>{await I(null),window.location.reload()})}async function q(){let e=document.querySelector(".settings"),t=!!self.showDirectoryPicker&&p;{e.querySelector(".settings__attach").classList.toggle("hidden",!t),e.querySelector(".settings__attach button.attach").classList.toggle("hidden",p);let n=e.querySelector(".settings__attach button.unattach");n.classList.toggle("hidden",!p),n.textContent=`Folder attached: ${p?.name}\u2013Click to unattach`}if(e.querySelector(".settings__copy").classList.toggle("hidden",t),!t){let r=e.querySelector(".settings__browser-files");r.innerHTML="";for(let{path:n,timestamp:i}of Q("/local")){let s=S("div","file");s.append(S("div","",n.replace("/local/",""))),s.append(S("div","",new Date(i).toLocaleString())),s.setAttribute("data-path",n),r.append(s)}}e.querySelector(".settings__download").classList.toggle("hidden",!!p);{let r=["zc.cfg","oot.cfg","2MGM.cfg","ultra.cfg","ppl160.cfg","freepats.cfg"],n=await H("timidity-cfg");(!n||!FS.analyzePath(`/etc/${n}`).exists)&&(n=r[0]);let i=e.querySelector(".settings__timidity-cfgs select");i.textContent="";for(let s of r){let o=S("option","",s);i.append(o)}i.addEventListener("change",async()=>{await b("timidity-cfg",i.value)}),i.value=n,FS.writeFile("/etc/timidity.cfg",FS.readFile(`/etc/${n}`))}}P();function ne(e){alert(e),window.location.reload()}async function re(){if(!(window.launchQueue&&"files"in LaunchParams.prototype)){document.body.textContent="This page is only for opening files from an installed PWA";return}await k();let e=J();if(!e){ne("Sorry, you can only open files this way if you've attached a folder. See Settings");return}document.querySelector(".content").classList.add("hidden"),document.querySelector(".file-handler").classList.remove("hidden");let t=await new Promise((o,a)=>{launchQueue.setConsumer(async l=>{if(console.log("...",l.files),!l.files.length){a(new Error("No files found"));return}o(l.files[0])})}),r=await e.resolve(t);if(!r){ne("Sorry, but that file is not inside the attached folder and cannot be opened directly");return}let i=`local/${r.join("/")}`,s=await new Promise(o=>{document.querySelectorAll(".file-handler button")[0].addEventListener("click",()=>{o(!1)}),document.querySelectorAll(".file-handler button")[1].addEventListener("click",()=>{o(!0)})});return document.querySelector(".content").classList.remove("hidden"),document.querySelector(".file-handler").classList.add("hidden"),{openInEditor:s,quest:i}}window.ZC={dataOrigin:"https://data.zquestclassic.com",pathToUrl:{},setStatus:function(e,t=null){if(e.startsWith("Downloading data... (")){let[,s,o]=e.match(/(\d+)\/(\d+)/);e=`Downloading data... (${L(s,o,"MB")})`,t=s/o}if(!e||e==="Running...")return;ZC.setStatus.last||(ZC.setStatus.last={time:Date.now(),text:""});let r=document.getElementById("status"),n=document.getElementById("progress");if(e==="Ready"){n.value=null,n.max=null,n.hidden=!0,r.hidden=!0;return}if(r.hidden=!1,e===ZC.setStatus.last.text)return;let i=Date.now();t&&i-ZC.setStatus.last.time<30||(ZC.setStatus.last.time=i,ZC.setStatus.last.text=e,t!==null&&t>0?(n.value=t,n.max=1,n.hidden=!1):(n.value=null,n.max=null,n.hidden=!0),r.innerHTML=e)},async fetch(e,t){let r=await G(e,t,(i,s,o)=>{o?ZC.setStatus("Ready"):i&&s?ZC.setStatus(`Fetching file (${L(i,s)})`,i/s):i?ZC.setStatus(`Fetching file (${L(i)})`):ZC.setStatus("Fetching file")});if(await r.headers.get("Content-Type")==="application/json"||e.endsWith(".json")){let i=new TextDecoder("utf-8").decode(await r.arrayBuffer());return JSON.parse(i)}return r},async getQuestManifest(){return ZC.questManifestPromise||(ZC.questManifestPromise=ZC.fetch(ZC.dataOrigin+"/manifest.json").catch(e=>(console.error(e.toString()),[]))),ZC.questManifestPromise},async fetchAsByteArray(e,t){let r=await ZC.fetch(e,t);return new Uint8Array(await r.arrayBuffer())},url:"",setShareableUrl(e){ZC.url=v("",e)},openTestMode(e,t,r,n){if(128<r)return;let i={test:e,dmap:t,screen:r};n!==-1&&(i.retsquare=n);let s=v(ZC_Constants.zeldaUrl,i);window.open(s,"_blank")},async runZscriptCompiler(e,t,r){e=PATH.join("/root-fs",e),t=PATH.join("/root-fs",t);let{default:n}=await import("./zscript.mjs"+(Math.random(),"")),i,s=new Promise(a=>i=a);await n({preRun(a){FS.analyzePath("/local/zscript.cfg").exists||FS.writeFile("/local/zscript.cfg",""),a.FS.mkdir("/root-fs"),a.FS.mount(PROXYFS,{root:"/",fs:FS},"/root-fs"),a.FS.chdir("/root-fs")},onExit:i,arguments:["-linked","-input",e,"-console",t,"-qr",r]});let o=await s;return await new Promise(a=>setTimeout(a,100)),{code:o}},async fsSync(e){await new Promise((t,r)=>FS.syncfs(e,n=>{if(n)return r(n);t()}))},configureMount:k};async function ke(){window.Module=window.Module||{},Module.noInitialRun=!0;let e,t=new Promise(o=>e=o);window.Module=Object.assign(Module,{arguments:[],canvas:document.querySelector("canvas"),instantiateWasm:qe,onRuntimeInitialized:()=>{if(TARGET==="zplayer")Ae();else for(let o of[...document.querySelectorAll(".touch-inputs")])o.classList.toggle("hidden",!0);xe(),te(),TARGET==="zeditor"&&Ce(),e()},setStatus:function(o,a=null){ZC.setStatus(o,a)},expectedDataFileDownloads:0,totalDependencies:0,monitorRunDependencies:function(o){if(Module.totalDependencies=Math.max(Module.totalDependencies,o),Module.totalDependencies===1)return;let a=(Module.totalDependencies-o)/Module.totalDependencies;ZC.setStatus(o?`Preparing... (${Module.totalDependencies-o}/${Module.totalDependencies})`:"",a)},onExit:function(o){let a=`exit with code: ${o}`;o===0?console.log(a):console.error(a)},preRun:[()=>{IS_CI&&(ENV.CI="1")}]});let r=new URLSearchParams(location.search),n=Module.arguments,i=r.get("open");if(i){let o=await ZC.getQuestManifest();i=i.startsWith("/")?i:`/${i}`;let a=i.startsWith("/quests/")&&i.match(/\/([^/]*\/[^/]*\/[^/]*)\/?(.*)?/);if(a){let[,l,u]=a;!u&&o[l]&&(i=`/${o[l].defaultPath}`),console.log({id:l,file:u,openPath:i})}}if(i&&(TARGET==="zeditor"?n.push(i):TARGET==="zplayer"&&n.push("-web-open",i)),TARGET==="zplayer"){let o=r.get("test"),a=r.get("screen"),l=r.get("dmap"),u=r.get("retsquare");o&&a&&l&&(n.push("-test",o,l,a),u&&n.push(u),document.querySelector(".button--testmode").classList.remove("hidden"))}for(let[o,a]of r.entries()){if(["test","screen","dmap","retsquare","open"].includes(o))continue;let l="-"+o.replace(/[A-Z]/g,(u,c)=>(c>0?"-":"")+u.toLowerCase());n.push(l),a!==""&&n.push(a)}window.addEventListener("resize",z),z();let s=()=>{navigator.storage.persist(),canvas.removeEventListener("click",s)};canvas.addEventListener("click",s);for(let o of[...document.querySelectorAll(".panel-button[data-panel]")])o.addEventListener("click",async()=>{for(let l of document.querySelectorAll(".panel-button")){let u=document.querySelector(l.getAttribute("data-panel"));o===l?(l.classList.toggle("active"),u&&u.classList.toggle("hidden"),u&&l.getAttribute("data-panel")===".settings"&&await q()):(l.classList.remove("active"),u&&u.classList.add("hidden"))}let a=!document.querySelector(".panel-button.active");document.body.classList.toggle("canvas-focus",a),document.querySelector(".content").classList.toggle("hidden",!a),a&&(z(),document.body.scrollIntoView())});if(document.body.classList.toggle("canvas-focus",!0),await t,callMain(Module.arguments),await _e(),r.has("launch")){let o=await re();o.openInEditor?window.location.href=v(ZC_Constants.zquestUrl,{open:o.quest}):window.location.href=v(ZC_Constants.zeldaUrl,{open:o.quest})}}function qe(e,t){function r(i){return getBinaryPromise().then(function(s){return WebAssembly.instantiate(s,e)}).then(function(s){return s}).then(i,function(s){err("failed to asynchronously prepare wasm: "+s),isFileURI(wasmBinaryFile)&&err("warning: Loading from a file URI ("+wasmBinaryFile+") is not supported in most browsers. See https://emscripten.org/docs/getting_started/FAQ.html#how-do-i-run-a-local-webserver-for-testing-why-does-my-program-stall-in-downloading-or-preparing"),abort(s)})}function n(i){t(i.instance,i.module)}return!wasmBinary&&typeof WebAssembly.instantiateStreaming=="function"&&!isDataURI(wasmBinaryFile)&&!isFileURI(wasmBinaryFile)&&typeof fetch=="function"?fetch(wasmBinaryFile,{credentials:"same-origin"}).then(function(i){var s=WebAssembly.instantiateStreaming(i,e);return s.then(n,function(o){return err("wasm streaming compile failed: "+o),err("falling back to ArrayBuffer instantiation"),r(n)})}):r(n)}function z(){let e=640,t=480,r=innerHeight-document.querySelector("header").clientHeight,n=Math.min(innerWidth/e,r/t);canvas.style.width=Math.floor(e*n)+"px",canvas.style.height=Math.floor(t*n)+"px"}async function _e(){let e=document.querySelector(".quest-list"),t=e.querySelector(".quest-list__entries-list"),r=e.querySelector(".quest-list__current"),n=document.querySelector(".tmpl-selected-quest"),i=await ZC.getQuestManifest(),s=Object.values(i);for(let c of s){if(!["auto",!0].includes(c.approval))continue;let d=document.createElement("div");d.classList.add("quest-list__entry"),d.setAttribute("data-quest-index",s.indexOf(c)),d.quest=c,d.append(c.name),t.append(d),d.tabIndex=-1}t.addEventListener("keyup",c=>{if(c.keyCode===38){let d=Number(c.target.previousElementSibling.getAttribute("data-quest-index")),f=s[d];o(f),c.target.previousElementSibling.focus()}else if(c.keyCode===40&&c.target.nextElementSibling){let d=Number(c.target.nextElementSibling.getAttribute("data-quest-index")),f=s[d];o(f),c.target.nextElementSibling.focus()}});function o(c){let d=`${ZC.dataOrigin}/${c.id}`;document.querySelector(".quest-list__entry.selected")?.classList.remove("selected"),document.querySelector(`.quest-list__entry[data-quest-index="${s.indexOf(c)}"]`).classList.add("selected");let f=n.content.cloneNode(!0).children[0];function m(h,g){g?f.querySelector(h).textContent=g:f.querySelector(h).parentElement.remove()}m(".name",c.name),m(".author",c.authors.map(h=>h.name).join(", ")),m(".genre",c.genre),m(".version",c.version),c.projectUrl?f.querySelector(".purezc-link").href=c.projectUrl:f.querySelector(".purezc-link").remove(),c.rating?(f.querySelector(".rating").textContent=c.rating.score,f.querySelector(".rating-votes").textContent=c.rating.distribution.reduce((h,g)=>h+g,0)):f.querySelector("._rating").remove(),c.informationHtml&&(f.querySelector(".information").innerHTML=c.informationHtml),c.descriptionHtml&&(f.querySelector(".description").innerHTML=c.descriptionHtml),c.storyHtml&&(f.querySelector(".story").innerHTML=c.storyHtml),c.tipsAndCheatsHtml&&(f.querySelector(".tips").innerHTML=c.tipsAndCheatsHtml),c.creditsHtml&&(f.querySelector(".credits").innerHTML=c.creditsHtml);function y(h){let g=document.createElement("img");g.crossOrigin="anonymous",g.src=`${d}/${h}`,f.querySelector(".current-image").innerHTML="",f.querySelector(".current-image").append(g)}let w=f.querySelector(".images");if(c.images.length>1)for(let h of c.images){let g=document.createElement("img");g.crossOrigin="anonymous",g.src=`${d}/${h}`,w.append(g),g.addEventListener("click",()=>{y(h)}),g.addEventListener("mouseover",()=>{y(h)})}c.images.length>0&&y(c.images[0]);let A=c.releases[0],x=A.resources.filter(h=>h.endsWith(".qst"));for(let h of x){let C={open:x.length>1?`${c.id}/${A.name}/${h}`:c.id};x.length===1&&(C.name=c.name.replace(/['!?]/g,"").replace(/[\s:&]+/g,"-").replace(/[-]+/g,"-"));let M=S("a","play-link");M.href=v(ZC_Constants.zeldaUrl,C),M.textContent="Play!";let T=S("a");T.href=v(ZC_Constants.zquestUrl,C),T.textContent="Open in Editor";let U=S("div","link-group");f.querySelector(".links").append(U),U.append(h,M,T)}r.textContent="",r.append(f)}t.addEventListener("click",c=>{let d=c.target.closest(".quest-list__entry");if(!d)return;let f=Number(d.getAttribute("data-quest-index")),m=s[f];o(m)});for(let c of document.querySelectorAll(".quest-list__sort-option"))c.addEventListener("click",()=>{let d=c.textContent,f;d==="Name"?f=(m,y)=>m.textContent.localeCompare(y.textContent):d==="Rating"&&(f=(m,y)=>{let w=m.quest.rating?.score||0;return(y.quest.rating?.score||0)-w}),[...t.children].sort(f).forEach(m=>t.appendChild(m))});let a=new URLSearchParams(location.search).get("quest"),l=a?a.match(/(quests\/purezc\/\d+)/)?.[0]:"",u=l&&s.find(c=>c.id==l)||s.find(c=>["auto",!0].includes(c.approval));u&&o(u)}function Ae(){let e=Module.cwrap("create_synthetic_key_event",null,["int","int"]),t={KEY_DOWN:10,KEY_CHAR:11,KEY_UP:12},r={B:26,A:24,Start:67,Map:75,L:1,R:19,Left:82,Right:83,Down:84,Up:85},n=(o,a)=>{if(o===-1)return r.Left;if(o===1)return r.Right;if(a===-1)return r.Down;if(a===1)return r.Up},i=(o,a)=>{o==="touchstart"&&e(t.KEY_DOWN,a),(o==="touchmove"||o==="touchstart")&&e(t.KEY_CHAR,a),o==="touchend"&&e(t.KEY_UP,a)},s=o=>{let a=o.getAttribute("data-action");if(a)return[r[a]];let l=[],u=Number(o.getAttribute("data-x")),c=Number(o.getAttribute("data-y"));return u&&l.push(n(u,0)),c&&l.push(n(0,c)),l};for(let o of document.querySelectorAll(".touch-inputs")){let a=null,l=c=>{a&&a.classList.remove("pressed"),a=c,a&&a.classList.add("pressed")},u=(c,d)=>{let f;if(c==="touchend"){if(d.targetTouches.length!==0)return;f=d.changedTouches[0]}else{if(d.targetTouches.length!==1)return;f=d.targetTouches[0]}let m=document.elementFromPoint(f.clientX,f.clientY),y=m.classList.contains("touch-input")?m:null;if(!(!y&&m.closest(".touch-inputs")===o&&c!=="touchend")){if(a&&(y!==a||!y))for(let w of s(a))i("touchend",w);if(!y){l(null);return}for(let w of s(y))i(c,w);l(c==="touchend"?null:y)}};o.addEventListener("touchstart",c=>u("touchstart",c)),o.addEventListener("touchmove",c=>u("touchmove",c)),o.addEventListener("touchend",c=>u("touchend",c)),o.addEventListener("touchcancel",c=>u("touchend",c)),o.addEventListener("contextmenu",c=>c.preventDefault())}}function xe(){let e=document.querySelector(".button--copyurl");e.classList.remove("hidden");let t=Module.cwrap("get_shareable_url","undefined",[]);e.addEventListener("click",()=>{t(),ZC.url&&navigator.clipboard.writeText(ZC.url)})}function Ce(){let e=document.querySelector(".button--open-testmode");e.classList.remove("hidden");let t=Module.cwrap("open_test_mode",null,[]);e.addEventListener("click",()=>{t()})}function $(){let e=navigator.getGamepads().some(Boolean);for(let t of[...document.querySelectorAll(".touch-inputs")])t.classList.toggle("hidden",e)}function Me(){document.querySelector("main").requestFullscreen()}ke().catch(e=>{console.error(e),document.querySelector(".content").textContent=e.toString()});$();window.addEventListener("gamepadconnected",$);window.addEventListener("gamepaddisconnected",$);var _=document.createElement("button");_.textContent="Fullscreen";_.classList.add("panel-button");_.addEventListener("click",Me);document.addEventListener("DOMContentLoaded",()=>{document.querySelector(".panel-buttons").append(_)});})();
//# sourceMappingURL=main.js.map
