(()=>{var G=e=>t=>{var n=e[t];if(n)return n();throw new Error("Module not found in bundle: "+t)};var Q=(e,t)=>()=>(e&&(t=e(e=0)),t);async function te(e,t,n){let r=await fetch(e,t),o=Number(r.headers.get("Content-Length")),s=r.headers.has("Content-Encoding")?Number(r.headers.get("X-Amz-Meta-Inflated-Content-Size")):null,i=o;(!Number.isInteger(o)||!Number.isFinite(o)||o<=0)&&(i=null);let a=s&&i?i/s:1,l=0;return new Response(new ReadableStream({async start(u){let c=r.body.getReader();for(;;){let{done:d,value:f}=await c.read();if(d){n(l*a,i,!0);break}l+=f.byteLength,n(l*a,i,!1),u.enqueue(f)}u.close()}}),{status:r.status,statusText:r.statusText,headers:r.headers})}function E(e,t){let n=new URL(e,location.href);n.search="";for(let[r,o]of Object.entries(t))r==="open"&&o.startsWith("/")&&(o=o.substr(1)),n.searchParams.set(r,o);return n.search=decodeURIComponent(n.search),n.toString()}function A(e){let t=[];if(!FS.analyzePath(e).exists)return t;function n(r){for(let o of FS.readdir(r)){if(o==="."||o==="..")continue;let s=`${r}/${o}`,{mode:i,timestamp:a}=FS.lookupPath(s).node;FS.isFile(i)?t.push({path:s,timestamp:a}):FS.isDir(i)&&n(s)}}return n(e),t}function v(e,t,n){let r=document.createElement(e);return t&&(r.className=t),r.textContent=n,r}function k(e,t,n){let r=t||e,o=1,s=0;return n===void 0&&(r>1024**2?n="MB":r>1024?n="KB":n="B"),n==="B"?(o=1,s=0):n==="KB"?(o=1024,s=0):n==="MB"&&(o=1024**2,s=1),t===void 0?`${(e/o).toFixed(s)} ${n}`:`${(e/o).toFixed(s)}/${(t/o).toFixed(s)} ${n}`}var ne,q=Q(()=>{ne=async e=>{let t=[];async function n(o){for await(let s of o.values())t.push(s),s.kind==="directory"&&await n(s)}await n(e);let r=new Map;r.set(".",e);for(let o of t){let s=(await e.resolve(o)).join("/");r.set(s,o)}return r}});var Te={};function Re(e,t){return Object.assign(e,t)}var re,oe=Q(()=>{q();re={library:{}};Re(re.library,{$FSFS__deps:["$FS","$MEMFS","$PATH"],$FSFS__postset:function(){return""},$FSFS:{DIR_MODE:16895,FILE_MODE:33279,mount:function(e){if(!e.opts.dirHandle)throw new Error("opts.dirHandle is required");return MEMFS.mount.apply(null,arguments)},syncfs:async(e,t,n)=>{try{let r=await FSFS.getLocalSet(e),o=await FSFS.getRemoteSet(e),s=t?o:r,i=t?r:o;await FSFS.reconcile(e,s,i),n(null)}catch(r){n(r)}},getLocalSet:e=>{var t=Object.create(null);function n(a){return a!=="."&&a!==".."}function r(a){return l=>PATH.join2(a,l)}for(var o=FS.readdir(e.mountpoint).filter(n).map(r(e.mountpoint));o.length;){var s=o.pop(),i=FS.stat(s);FS.isDir(i.mode)&&o.push.apply(o,FS.readdir(s).filter(n).map(r(s))),t[s]={timestamp:i.mtime,mode:i.mode}}return{type:"local",entries:t}},getRemoteSet:async e=>{let t=Object.create(null),n=await ne(e.opts.dirHandle,!0);for(let[r,o]of n)r!=="."&&(t[PATH.join2(e.mountpoint,r)]={timestamp:o.kind==="file"?(await o.getFile()).lastModifiedDate:new Date,mode:o.kind==="file"?FSFS.FILE_MODE:FSFS.DIR_MODE});return{type:"remote",entries:t,handles:n}},loadLocalEntry:e=>{let n=FS.lookupPath(e).node,r=FS.stat(e);if(FS.isDir(r.mode))return{timestamp:r.mtime,mode:r.mode};if(FS.isFile(r.mode))return n.contents=MEMFS.getFileDataAsTypedArray(n),{timestamp:r.mtime,mode:r.mode,contents:n.contents};throw new Error("node type not supported")},storeLocalEntry:(e,t)=>{if(FS.isDir(t.mode))FS.mkdirTree(e,t.mode);else if(FS.isFile(t.mode))FS.writeFile(e,t.contents,{canOwn:!0});else throw new Error("node type not supported");FS.chmod(e,t.mode),FS.utime(e,t.timestamp,t.timestamp)},removeLocalEntry:e=>{var t=FS.stat(e);FS.isDir(t.mode)?FS.rmdir(e):FS.isFile(t.mode)&&FS.unlink(e)},loadRemoteEntry:async e=>{if(e.kind==="file"){let t=await e.getFile();return{contents:new Uint8Array(await t.arrayBuffer()),mode:FSFS.FILE_MODE,timestamp:t.lastModifiedDate}}else{if(e.kind==="directory")return{mode:FSFS.DIR_MODE,timestamp:new Date};throw new Error("unknown kind: "+e.kind)}},storeRemoteEntry:async(e,t,n)=>{let r=e.get(PATH.dirname(t)),o=FS.isFile(n.mode)?await r.getFileHandle(PATH.basename(t),{create:!0}):await r.getDirectoryHandle(PATH.basename(t),{create:!0});if(o.kind==="file"){let s=await o.createWritable();await s.write(n.contents),await s.close()}e.set(t,o)},removeRemoteEntry:async(e,t)=>{await e.get(PATH.dirname(t)).removeEntry(PATH.basename(t)),e.delete(t)},reconcile:async(e,t,n)=>{let r=0,o=[];Object.keys(t.entries).forEach(function(a){let l=t.entries[a],u=n.entries[a];(!u||FS.isFile(l.mode)&&l.timestamp.getTime()>u.timestamp.getTime())&&(o.push(a),r++)}),o.sort();let s=[];if(Object.keys(n.entries).forEach(function(a){t.entries[a]||(s.push(a),r++)}),s.sort().reverse(),!r)return;let i=t.type==="remote"?t.handles:n.handles;for(let a of o){let l=PATH.normalize(a.replace(e.mountpoint,"/")).substring(1);if(n.type==="local"){let u=i.get(l),c=await FSFS.loadRemoteEntry(u);FSFS.storeLocalEntry(a,c)}else{let u=FSFS.loadLocalEntry(a);await FSFS.storeRemoteEntry(i,l,u)}}for(let a of s)if(n.type==="local")FSFS.removeLocalEntry(a);else{let l=PATH.normalize(a.replace(e.mountpoint,"/")).substring(1);await FSFS.removeRemoteEntry(i,l)}}}});globalThis.FSFS=re.library.$FSFS;FS.filesystems.FSFS=FSFS});var I=(()=>{if(typeof self>"u")return!1;if("top"in self&&self!==top)try{top.window.document._=0}catch{return!1}return"showOpenFilePicker"in self})(),ye=I?Promise.resolve().then(function(){return ve}):Promise.resolve().then(function(){return Pe});async function Y(...e){return(await ye).default(...e)}var he=I?Promise.resolve().then(function(){return Ee}):Promise.resolve().then(function(){return ke});async function V(...e){return(await he).default(...e)}var ge=I?Promise.resolve().then(function(){return Le}):Promise.resolve().then(function(){return Me});async function X(...e){return(await ge).default(...e)}var we=async e=>{let t=await e.getFile();return t.handle=e,t},Se=async(e=[{}])=>{Array.isArray(e)||(e=[e]);let t=[];e.forEach((o,s)=>{t[s]={description:o.description||"Files",accept:{}},o.mimeTypes?o.mimeTypes.map(i=>{t[s].accept[i]=o.extensions||[]}):t[s].accept["*/*"]=o.extensions||[]});let n=await window.showOpenFilePicker({id:e[0].id,startIn:e[0].startIn,types:t,multiple:e[0].multiple||!1,excludeAcceptAllOption:e[0].excludeAcceptAllOption||!1}),r=await Promise.all(n.map(we));return e[0].multiple?r:r[0]},ve={__proto__:null,default:Se};function L(e){function t(n){if(Object(n)!==n)return Promise.reject(new TypeError(n+" is not an object."));var r=n.done;return Promise.resolve(n.value).then(function(o){return{value:o,done:r}})}return L=function(n){this.s=n,this.n=n.next},L.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(n){var r=this.s.return;return r===void 0?Promise.resolve({value:n,done:!0}):t(r.apply(this.s,arguments))},throw:function(n){var r=this.s.return;return r===void 0?Promise.reject(n):t(r.apply(this.s,arguments))}},new L(e)}var J=async(e,t,n=e.name,r)=>{let o=[],s=[];var i,a=!1,l=!1;try{for(var u,c=function(d){var f,m,y,w=2;for(typeof Symbol<"u"&&(m=Symbol.asyncIterator,y=Symbol.iterator);w--;){if(m&&(f=d[m])!=null)return f.call(d);if(y&&(f=d[y])!=null)return new L(f.call(d));m="@@asyncIterator",y="@@iterator"}throw new TypeError("Object is not async iterable")}(e.values());a=!(u=await c.next()).done;a=!1){let d=u.value,f=`${n}/${d.name}`;d.kind==="file"?s.push(d.getFile().then(m=>(m.directoryHandle=e,m.handle=d,Object.defineProperty(m,"webkitRelativePath",{configurable:!0,enumerable:!0,get:()=>f})))):d.kind!=="directory"||!t||r&&r(d)||o.push(J(d,t,f,r))}}catch(d){l=!0,i=d}finally{try{a&&c.return!=null&&await c.return()}finally{if(l)throw i}}return[...(await Promise.all(o)).flat(),...await Promise.all(s)]},Fe=async(e={})=>{e.recursive=e.recursive||!1,e.mode=e.mode||"read";let t=await window.showDirectoryPicker({id:e.id,startIn:e.startIn,mode:e.mode});return(await(await t.values()).next()).done?[t]:J(t,e.recursive,void 0,e.skipDirectory)},Ee={__proto__:null,default:Fe},be=async(e,t=[{}],n=null,r=!1,o=null)=>{Array.isArray(t)||(t=[t]),t[0].fileName=t[0].fileName||"Untitled";let s=[],i=null;if(e instanceof Blob&&e.type?i=e.type:e.headers&&e.headers.get("content-type")&&(i=e.headers.get("content-type")),t.forEach((u,c)=>{s[c]={description:u.description||"Files",accept:{}},u.mimeTypes?(c===0&&i&&u.mimeTypes.push(i),u.mimeTypes.map(d=>{s[c].accept[d]=u.extensions||[]})):i?s[c].accept[i]=u.extensions||[]:s[c].accept["*/*"]=u.extensions||[]}),n)try{await n.getFile()}catch(u){if(n=null,r)throw u}let a=n||await window.showSaveFilePicker({suggestedName:t[0].fileName,id:t[0].id,startIn:t[0].startIn,types:s,excludeAcceptAllOption:t[0].excludeAcceptAllOption||!1});!n&&o&&o(a);let l=await a.createWritable();return"stream"in e?(await e.stream().pipeTo(l),a):"body"in e?(await e.body.pipeTo(l),a):(await l.write(await e),await l.close(),a)},Le={__proto__:null,default:be},_e=async(e=[{}])=>(Array.isArray(e)||(e=[e]),new Promise((t,n)=>{let r=document.createElement("input");r.type="file";let o=[...e.map(l=>l.mimeTypes||[]),...e.map(l=>l.extensions||[])].join();r.multiple=e[0].multiple||!1,r.accept=o||"",r.style.display="none",document.body.append(r);let s=l=>{typeof i=="function"&&i(),t(l)},i=e[0].legacySetup&&e[0].legacySetup(s,()=>i(n),r),a=()=>{window.removeEventListener("focus",a),r.remove()};r.addEventListener("click",()=>{window.addEventListener("focus",a)}),r.addEventListener("change",()=>{window.removeEventListener("focus",a),r.remove(),s(r.multiple?Array.from(r.files):r.files[0])}),"showPicker"in HTMLInputElement.prototype?r.showPicker():r.click()})),Pe={__proto__:null,default:_e},Ae=async(e=[{}])=>(Array.isArray(e)||(e=[e]),e[0].recursive=e[0].recursive||!1,new Promise((t,n)=>{let r=document.createElement("input");r.type="file",r.webkitdirectory=!0;let o=i=>{typeof s=="function"&&s(),t(i)},s=e[0].legacySetup&&e[0].legacySetup(o,()=>s(n),r);r.addEventListener("change",()=>{let i=Array.from(r.files);e[0].recursive?e[0].recursive&&e[0].skipDirectory&&(i=i.filter(a=>a.webkitRelativePath.split("/").every(l=>!e[0].skipDirectory({name:l,kind:"directory"})))):i=i.filter(a=>a.webkitRelativePath.split("/").length===2),o(i)}),"showPicker"in HTMLInputElement.prototype?r.showPicker():r.click()})),ke={__proto__:null,default:Ae},qe=async(e,t={})=>{Array.isArray(t)&&(t=t[0]);let n=document.createElement("a"),r=e;"body"in e&&(r=await async function(i,a){let l=i.getReader(),u=new ReadableStream({start:f=>async function m(){return l.read().then(({done:y,value:w})=>{if(!y)return f.enqueue(w),m();f.close()})}()}),c=new Response(u),d=await c.blob();return l.releaseLock(),new Blob([d],{type:a})}(e.body,e.headers.get("content-type"))),n.download=t.fileName||"Untitled",n.href=URL.createObjectURL(await r);let o=()=>{typeof s=="function"&&s()},s=t.legacySetup&&t.legacySetup(o,()=>s(),n);return n.addEventListener("click",()=>{setTimeout(()=>URL.revokeObjectURL(n.href),3e4),o()}),n.click(),null},Me={__proto__:null,default:qe};function _(e){return new Promise((t,n)=>{e.oncomplete=e.onsuccess=()=>t(e.result),e.onabort=e.onerror=()=>n(e.error)})}function xe(e,t){let n=indexedDB.open(e);n.onupgradeneeded=()=>n.result.createObjectStore(t);let r=_(n);return(o,s)=>r.then(i=>s(i.transaction(t,o).objectStore(t)))}var $;function U(){return $||($=xe("keyval-store","keyval")),$}function z(e,t=U()){return t("readonly",n=>_(n.get(e)))}function P(e,t,n=U()){return n("readwrite",r=>(r.put(t,e),_(r.transaction)))}function ee(e,t=U()){return t("readwrite",n=>(n.delete(e),_(n.transaction)))}q();var p=null;function ie(){return p}var se,He=new Promise(e=>{se=e});async function M(){let e=new URLSearchParams(location.search).get("storage");e!=="fs"&&e!=="idb"&&(e=void 0),e===void 0&&(p=await z("attached-dir"),!self.showDirectoryPicker||p===!1||!await De()?(e="idb",p=null):e="fs"),FS.mkdirTree("/local"),e==="fs"?await Z(p):FS.mount(IDBFS,{},"/local"),await ZC.fsSync(!0),FS.analyzePath("/local/zc.cfg").exists||FS.writeFile("/local/zc.cfg",FS.readFile("/zc_web.cfg")),FS.analyzePath("/local/zquest.cfg").exists||FS.writeFile("/local/zquest.cfg",FS.readFile("/zquest_web.cfg")),await x(),se()}async function De(){let e={mode:"readwrite"};if(p){if(await p.queryPermission(e)==="granted")return!0;try{return await p.requestPermission(e)==="granted"}catch{}}document.querySelector(".content").classList.add("hidden"),document.querySelector(".permission").classList.remove("hidden"),document.querySelector(".permission .folder-name").textContent=p?.name,document.querySelector(".permission .already-attached").classList.toggle("hidden",!p),document.querySelector(".permission .not-attached").classList.toggle("hidden",!!p);let t=await new Promise(n=>{document.querySelector(".permission .ok").addEventListener("click",()=>{n(!0)}),document.querySelector(".permission .cancel").addEventListener("click",()=>{P("attached-dir",!1),n(!1)})});if(t&&!p)try{p=await self.showDirectoryPicker({id:"zc"})}catch{}return t&&p&&(t=await p.requestPermission(e)==="granted"),document.querySelector(".content").classList.remove("hidden"),document.querySelector(".permission").classList.add("hidden"),t}async function Z(e){try{FS.unmount("/local")}catch{}p=e,e?await P("attached-dir",e):await ee("attached-dir"),e&&(await Promise.resolve().then(()=>(oe(),Te)),FS.mount(FSFS,{dirHandle:p},"/local"),await new Promise((t,n)=>FS.syncfs(!0,r=>{if(r)return n(r);t()})))}function ae(){let e=document.querySelector(".settings");e.querySelector(".settings__browser-files").addEventListener("click",async o=>{let s=o.target.closest("[data-path]");if(!s)return;let i=s.getAttribute("data-path"),a=new Blob([FS.readFile(i)]);await X(a,{fileName:i.replace("/local/","")})});let n=["zc.cfg","zquest.cfg","zc.sav"];async function r(o){await He;for(let s of o){let i;s.webkitRelativePath?i=[...PATH.dirname(s.webkitRelativePath).split("/").slice(1),PATH.basename(s.webkitRelativePath)].join("/"):i=s.name;let a="/local/"+i;if(FS.analyzePath(a).exists){let l="/local/.backup/"+i;FS.mkdirTree(PATH.dirname(l)),FS.writeFile(l,FS.readFile(a))}FS.mkdirTree(PATH.dirname(a)),FS.writeFile(a,new Uint8Array(await s.arrayBuffer()))}await ZC.fsSync(!1),o.some(s=>n.includes(s.name))&&window.location.reload(),await x()}e.querySelector(".settings__copy button.copy-folder").addEventListener("click",async()=>{let o=await V({recursive:!0});await r(o)}),e.querySelector(".settings__copy button.copy-file").addEventListener("click",async()=>{let o=await Y();await r([o])}),e.querySelector(".settings__attach button.attach").addEventListener("click",async()=>{let o=await self.showDirectoryPicker({id:"zc"});await Z(o),window.location.reload()}),e.querySelector(".settings__attach button.unattach").addEventListener("click",async()=>{await Z(null),window.location.reload()})}async function x(){let e=document.querySelector(".settings"),t=!!self.showDirectoryPicker&&p;{e.querySelector(".settings__attach").classList.toggle("hidden",!t),e.querySelector(".settings__attach button.attach").classList.toggle("hidden",p);let r=e.querySelector(".settings__attach button.unattach");r.classList.toggle("hidden",!p),r.textContent=`Folder attached: ${p?.name}\u2013Click to unattach`}if(e.querySelector(".settings__copy").classList.toggle("hidden",t),!t){let n=e.querySelector(".settings__browser-files");n.innerHTML="";for(let{path:r,timestamp:o}of A("/local")){let s=v("div","file");s.append(v("div","",r.replace("/local/",""))),s.append(v("div","",new Date(o).toLocaleString())),s.setAttribute("data-path",r),n.append(s)}}e.querySelector(".settings__download").classList.toggle("hidden",!!p);{let n=["zc.cfg","oot.cfg","2MGM.cfg","ultra.cfg","ppl160.cfg","freepats.cfg"],r=await z("timidity-cfg");(!r||!FS.analyzePath(`/etc/${r}`).exists)&&(r=n[0]);let o=e.querySelector(".settings__timidity-cfgs select");o.textContent="";for(let s of n){let i=v("option","",s);o.append(i)}o.addEventListener("change",async()=>{await P("timidity-cfg",o.value)}),o.value=r,FS.writeFile("/etc/timidity.cfg",FS.readFile(`/etc/${r}`))}}q();function ce(e){alert(e),window.location.reload()}async function le(){if(!(window.launchQueue&&"files"in LaunchParams.prototype)){document.body.textContent="This page is only for opening files from an installed PWA";return}await M();let e=ie();if(!e){ce("Sorry, you can only open files this way if you've attached a folder. See Settings");return}document.querySelector(".content").classList.add("hidden"),document.querySelector(".file-handler").classList.remove("hidden");let t=await new Promise((i,a)=>{launchQueue.setConsumer(async l=>{if(console.log("...",l.files),!l.files.length){a(new Error("No files found"));return}i(l.files[0])})}),n=await e.resolve(t);if(!n){ce("Sorry, but that file is not inside the attached folder and cannot be opened directly");return}let o=`local/${n.join("/")}`,s=await new Promise(i=>{document.querySelectorAll(".file-handler button")[0].addEventListener("click",()=>{i(!1)}),document.querySelectorAll(".file-handler button")[1].addEventListener("click",()=>{i(!0)})});return document.querySelector(".content").classList.remove("hidden"),document.querySelector(".file-handler").classList.add("hidden"),{openInEditor:s,quest:o}}var B=new Map,ue=new Map,Oe=1,b=new Map,S={doCommands:null,getRegister:null,setRegister:null,runtimeDebug:null},Ie=1;function $e(e){let t=Ie++,n=`${t} - ${ue.get(e)}`,r=B.get(e),o={id:t,instance:r,name:n};return b.set(t,o),o}function Ue(e,t){if(!e)throw new Error(t)}function C(){Ue(typeof window<"u","expected to be called from main thread")}var F;function ze(e){F=e}async function de(e,t,n){C(),S.doCommands||(S.doCommands=Module.cwrap("em_do_commands","int",["int","int","int"]),S.doCommandsAsync=Module.cwrap("em_do_commands","int",["int","int","int"],{async:!0}),S.getRegister=Module.cwrap("em_get_register","int",["int"]),S.setRegister=Module.cwrap("em_set_register","void",["int","int"]),S.runtimeDebug=Module.cwrap("em_runtime_script_debug","void",["int","int"])),console.log(`compiling ${e}, ${n} len`);try{let r=new Uint8Array(Module.HEAPU8.buffer,t,n),o=await WebAssembly.compile(r);console.log(`compiling ${e} DONE`);let s=Oe++,i=await WebAssembly.instantiate(o,{env:{memory:Module.wasmMemory,set_return_value:ze,do_commands:S.doCommands,do_commands_async:S.doCommandsAsync,get_register:S.getRegister,set_register:S.setRegister,runtime_debug:S.runtimeDebug}});return B.set(s,i),ue.set(s,e),s}catch(r){return console.error(`error compiling ${e}`,r),0}}async function fe(e){if(C(),!B.get(e))return 0;let{id:n}=$e(e);return n}async function me(e,t){C();let n=b.get(e);if(!n)return!1;let r=Module.HEAP32[t/4],o=Module.HEAP32[t/4+1],s=Module.HEAP32[t/4+2],i=Module.HEAP32[t/4+3],a=Module.HEAP32[t/4+4],l=[r,o,s,i,a];n.args=l;let u=0,c=1;F=-1;try{n.instance.exports.run(...l),F=u}catch(d){if(F===-1&&(F=c),F==c)return console.error(d),F}return F}async function j(e){return C(),b.get(e)?(b.delete(e),!0):!1}async function pe(){for(let e of b.keys())await j(e)}var Ze=G({});globalThis.ZC={dataOrigin:"https://zc-data.nyc3.digitaloceanspaces.com",pathToUrl:{},setStatus:function(e,t=null){if(e.startsWith("Downloading data... (")){let[,s,i]=e.match(/(\d+)\/(\d+)/);e=`Downloading data... (${k(s,i,"MB")})`,t=s/i}if(!e||e==="Running...")return;ZC.setStatus.last||(ZC.setStatus.last={time:Date.now(),text:""});let n=document.getElementById("status"),r=document.getElementById("progress");if(e==="Ready"){r.value=null,r.max=null,r.hidden=!0,n.hidden=!0;return}if(n.hidden=!1,e===ZC.setStatus.last.text)return;let o=Date.now();t&&o-ZC.setStatus.last.time<30||(ZC.setStatus.last.time=o,ZC.setStatus.last.text=e,t!==null&&t>0?(r.value=t,r.max=1,r.hidden=!1):(r.value=null,r.max=null,r.hidden=!0),n.innerHTML=e)},async fetch(e,t){let n=await te(e,t,(o,s,i)=>{i?ZC.setStatus("Ready"):o&&s?ZC.setStatus(`Fetching file (${k(o,s)})`,o/s):o?ZC.setStatus(`Fetching file (${k(o)})`):ZC.setStatus("Fetching file")});if(await n.headers.get("Content-Type")==="application/json"||e.endsWith(".json")){let o=new TextDecoder("utf-8").decode(await n.arrayBuffer());return JSON.parse(o)}return n},async getQuestManifest(){return ZC.questManifestPromise||(ZC.questManifestPromise=ZC.fetch(ZC.dataOrigin+"/manifest.json").catch(e=>(console.error(e.toString()),[]))),ZC.questManifestPromise},async fetchAsByteArray(e,t){let n=await ZC.fetch(e,t);return new Uint8Array(await n.arrayBuffer())},url:"",setShareableUrl(e){ZC.url=E("",e)},openTestMode(e,t,n,r){if(128<n)return;let o={test:e,dmap:t,screen:n};r!==-1&&(o.retsquare=r);let s=E(ZC_Constants.zeldaUrl,o);window.open(s,"_blank")},async runZscriptCompiler(e,t,n){e=PATH.join("/root-fs",e),t=PATH.join("/root-fs",t);let{default:r}=await Ze("./zscript.mjs"+(Math.random(),"")),o,s=new Promise(a=>o=a);await r({preRun(a){FS.analyzePath("/local/zscript.cfg").exists||FS.writeFile("/local/zscript.cfg",""),a.FS.mkdir("/root-fs"),a.FS.mount(PROXYFS,{root:"/",fs:FS},"/root-fs"),a.FS.chdir("/root-fs")},onExit:o,arguments:["-linked","-input",e,"-console",t,"-qr",n]});let i=await s;return await new Promise(a=>setTimeout(a,100)),{code:i}},async fsSync(e){await new Promise((t,n)=>FS.syncfs(e,r=>{if(r)return n(r);t()}))},configureMount:M,fsReadAllFiles:A,compileScriptWasmModule:de,createScriptWasmHandle:fe,pollScriptWasmHandle:me,destroyScriptWasmHandle:j,destroyAllScriptWasmHandles:pe};async function Be(){window.Module=window.Module||{},Module.noInitialRun=!0;let e,t=new Promise(i=>e=i);window.Module=Object.assign(Module,{arguments:[],canvas:document.querySelector("canvas"),instantiateWasm:je,onRuntimeInitialized:()=>{if(TARGET==="zplayer")Ne();else for(let i of[...document.querySelectorAll(".touch-inputs")])i.classList.toggle("hidden",!0);Ke(),ae(),TARGET==="zeditor"&&Ge(),e()},setStatus:function(i,a=null){ZC.setStatus(i,a)},expectedDataFileDownloads:0,totalDependencies:0,monitorRunDependencies:function(i){if(Module.totalDependencies=Math.max(Module.totalDependencies,i),Module.totalDependencies===1)return;let a=(Module.totalDependencies-i)/Module.totalDependencies;ZC.setStatus(i?`Preparing... (${Module.totalDependencies-i}/${Module.totalDependencies})`:"",a)},onExit:function(i){let a=`exit with code: ${i}`;i===0?console.log(a):console.error(a)},preRun:[()=>{IS_CI&&(ENV.CI="1")}],locateFile:function(i,a){return new URL(i,a||rootUrl).href}});let n=new URLSearchParams(location.search),r=Module.arguments,o=n.get("open");if(o){let i=await ZC.getQuestManifest();o=o.startsWith("/")?o:`/${o}`;let a=(o.startsWith("/quests/")||o.startsWith("/tilesets/"))&&o.match(/\/([^/]*\/[^/]*\/[^/]*)\/?(.*)?/);if(a){let[,l,u]=a;!u&&i[l]&&(o=`/${i[l].defaultPath}`)}}if(o&&(TARGET==="zeditor"?r.push(o):TARGET==="zplayer"&&r.push("-web-open",o)),TARGET==="zplayer"){let i=n.get("test"),a=n.get("screen"),l=n.get("dmap"),u=n.get("retsquare");i&&a&&l&&(r.push("-test",i,l,a),u&&r.push(u),document.querySelector(".button--testmode").classList.remove("hidden"))}for(let[i,a]of n.entries()){if(["test","screen","dmap","retsquare","open"].includes(i))continue;let l="-"+i.replace(/[A-Z]/g,(u,c)=>(c>0?"-":"")+u.toLowerCase());r.push(l),a!==""&&r.push(a)}window.addEventListener("resize",W),W();let s=()=>{navigator.storage.persist(),canvas.removeEventListener("click",s)};canvas.addEventListener("click",s);for(let i of[...document.querySelectorAll(".panel-button[data-panel]")])i.addEventListener("click",async()=>{for(let l of document.querySelectorAll(".panel-button")){let u=document.querySelector(l.getAttribute("data-panel"));i===l?(l.classList.toggle("active"),u&&u.classList.toggle("hidden"),u&&l.getAttribute("data-panel")===".settings"&&await x()):(l.classList.remove("active"),u&&u.classList.add("hidden"))}let a=!document.querySelector(".panel-button.active");document.body.classList.toggle("canvas-focus",a),document.querySelector(".content").classList.toggle("hidden",!a),a&&(W(),document.body.scrollIntoView())});if(document.body.classList.toggle("canvas-focus",!0),await t,callMain(Module.arguments),await We(),n.has("launch")){let i=await le();i.openInEditor?window.location.href=E(ZC_Constants.zquestUrl,{open:i.quest}):window.location.href=E(ZC_Constants.zeldaUrl,{open:i.quest})}}function je(e,t){function n(o){return getBinaryPromise().then(function(s){return WebAssembly.instantiate(s,e)}).then(function(s){return s}).then(o,function(s){err("failed to asynchronously prepare wasm: "+s),isFileURI(wasmBinaryFile)&&err("warning: Loading from a file URI ("+wasmBinaryFile+") is not supported in most browsers. See https://emscripten.org/docs/getting_started/FAQ.html#how-do-i-run-a-local-webserver-for-testing-why-does-my-program-stall-in-downloading-or-preparing"),abort(s)})}function r(o){t(o.instance,o.module)}return!wasmBinary&&typeof WebAssembly.instantiateStreaming=="function"&&!isDataURI(wasmBinaryFile)&&!isFileURI(wasmBinaryFile)&&typeof fetch=="function"?fetch(wasmBinaryFile,{credentials:"same-origin"}).then(function(o){var s=WebAssembly.instantiateStreaming(o,e);return s.then(r,function(i){return err("wasm streaming compile failed: "+i),err("falling back to ArrayBuffer instantiation"),n(r)})}):n(r)}function W(){let e=640,t=480,n=innerHeight-document.querySelector("header").clientHeight,r=Math.min(innerWidth/e,n/t);canvas.style.width=Math.floor(e*r)+"px",canvas.style.height=Math.floor(t*r)+"px"}async function We(){let e=document.querySelector(".quest-list"),t=e.querySelector(".quest-list__entries-list"),n=e.querySelector(".quest-list__current"),r=document.querySelector(".tmpl-selected-quest"),o=await ZC.getQuestManifest(),s=Object.values(o);for(let c of s){if(c.type!=="quests"||!["auto",!0].includes(c.approval))continue;let d=document.createElement("div");d.classList.add("quest-list__entry"),d.setAttribute("data-quest-index",s.indexOf(c)),d.quest=c,d.append(c.name),t.append(d),d.tabIndex=-1}t.addEventListener("keyup",c=>{if(c.keyCode===38){let d=Number(c.target.previousElementSibling.getAttribute("data-quest-index")),f=s[d];i(f),c.target.previousElementSibling.focus()}else if(c.keyCode===40&&c.target.nextElementSibling){let d=Number(c.target.nextElementSibling.getAttribute("data-quest-index")),f=s[d];i(f),c.target.nextElementSibling.focus()}});function i(c){let d=`${ZC.dataOrigin}/${c.id}`;document.querySelector(".quest-list__entry.selected")?.classList.remove("selected"),document.querySelector(`.quest-list__entry[data-quest-index="${s.indexOf(c)}"]`).classList.add("selected");let f=r.content.cloneNode(!0).children[0];function m(h,g){g?f.querySelector(h).textContent=g:f.querySelector(h).parentElement.remove()}m(".name",c.name),m(".author",c.authors.map(h=>h.name).join(", ")),m(".genre",c.genre),m(".version",c.version),c.projectUrl?f.querySelector(".purezc-link").href=c.projectUrl:f.querySelector(".purezc-link").remove(),c.rating?(f.querySelector(".rating").textContent=c.rating.score,f.querySelector(".rating-votes").textContent=c.rating.distribution.reduce((h,g)=>h+g,0)):f.querySelector("._rating").remove(),c.informationHtml&&(f.querySelector(".information").innerHTML=c.informationHtml),c.descriptionHtml&&(f.querySelector(".description").innerHTML=c.descriptionHtml),c.storyHtml&&(f.querySelector(".story").innerHTML=c.storyHtml),c.tipsAndCheatsHtml&&(f.querySelector(".tips").innerHTML=c.tipsAndCheatsHtml),c.creditsHtml&&(f.querySelector(".credits").innerHTML=c.creditsHtml);function y(h){let g=document.createElement("img");g.crossOrigin="anonymous",g.src=`${d}/${h}`,f.querySelector(".current-image").innerHTML="",f.querySelector(".current-image").append(g)}let w=f.querySelector(".images");if(c.images.length>1)for(let h of c.images){let g=document.createElement("img");g.crossOrigin="anonymous",g.src=`${d}/${h}`,w.append(g),g.addEventListener("click",()=>{y(h)}),g.addEventListener("mouseover",()=>{y(h)})}c.images.length>0&&y(c.images[0]);let R=c.releases[0],T=R.resources.filter(h=>h.endsWith(".qst"));for(let h of T){let H={open:T.length>1?`${c.id}/${R.name}/${h}`:c.id};T.length===1&&(H.name=c.name.replace(/['!?]/g,"").replace(/[\s:&]+/g,"-").replace(/[-]+/g,"-"));let D=v("a","play-link");D.href=E(ZC_Constants.zeldaUrl,H),D.textContent="Play!";let O=v("a");O.href=E(ZC_Constants.zquestUrl,H),O.textContent="Open in Editor";let K=v("div","link-group");f.querySelector(".links").append(K),K.append(h,D,O)}n.textContent="",n.append(f)}t.addEventListener("click",c=>{let d=c.target.closest(".quest-list__entry");if(!d)return;let f=Number(d.getAttribute("data-quest-index")),m=s[f];i(m)});for(let c of document.querySelectorAll(".quest-list__sort-option"))c.addEventListener("click",()=>{let d=c.textContent,f;d==="Name"?f=(m,y)=>m.textContent.localeCompare(y.textContent):d==="Rating"&&(f=(m,y)=>{let w=m.quest.rating?.score||0;return(y.quest.rating?.score||0)-w}),[...t.children].sort(f).forEach(m=>t.appendChild(m))});let a=new URLSearchParams(location.search).get("quest"),l=a?a.match(/(quests\/purezc\/\d+)/)?.[0]:"",u=l&&s.find(c=>c.id==l)||s.find(c=>["auto",!0].includes(c.approval));u&&i(u)}function Ne(){let e=Module.cwrap("create_synthetic_key_event",null,["int","int"]),t={KEY_DOWN:10,KEY_CHAR:11,KEY_UP:12},n={B:26,A:24,Start:67,Map:75,L:1,R:19,Left:82,Right:83,Down:84,Up:85},r=(i,a)=>{if(i===-1)return n.Left;if(i===1)return n.Right;if(a===-1)return n.Down;if(a===1)return n.Up},o=(i,a)=>{i==="touchstart"&&e(t.KEY_DOWN,a),(i==="touchmove"||i==="touchstart")&&e(t.KEY_CHAR,a),i==="touchend"&&e(t.KEY_UP,a)},s=i=>{let a=i.getAttribute("data-action");if(a)return[n[a]];let l=[],u=Number(i.getAttribute("data-x")),c=Number(i.getAttribute("data-y"));return u&&l.push(r(u,0)),c&&l.push(r(0,c)),l};for(let i of document.querySelectorAll(".touch-inputs")){let a=null,l=c=>{a&&a.classList.remove("pressed"),a=c,a&&a.classList.add("pressed")},u=(c,d)=>{let f;if(c==="touchend"){if(d.targetTouches.length!==0)return;f=d.changedTouches[0]}else{if(d.targetTouches.length!==1)return;f=d.targetTouches[0]}let m=document.elementFromPoint(f.clientX,f.clientY),y=m.classList.contains("touch-input")?m:null;if(!(!y&&m.closest(".touch-inputs")===i&&c!=="touchend")){if(a&&(y!==a||!y))for(let w of s(a))o("touchend",w);if(!y){l(null);return}for(let w of s(y))o(c,w);l(c==="touchend"?null:y)}};i.addEventListener("touchstart",c=>u("touchstart",c)),i.addEventListener("touchmove",c=>u("touchmove",c)),i.addEventListener("touchend",c=>u("touchend",c)),i.addEventListener("touchcancel",c=>u("touchend",c)),i.addEventListener("contextmenu",c=>c.preventDefault())}}function Ke(){let e=document.querySelector(".button--copyurl");e.classList.remove("hidden");let t=Module.cwrap("get_shareable_url","undefined",[]);e.addEventListener("click",()=>{t(),ZC.url&&navigator.clipboard.writeText(ZC.url)})}function Ge(){let e=document.querySelector(".button--open-testmode");e.classList.remove("hidden");let t=Module.cwrap("open_test_mode",null,[]);e.addEventListener("click",()=>{t()})}function N(){let e=navigator.getGamepads().some(Boolean);for(let t of[...document.querySelectorAll(".touch-inputs")])t.classList.toggle("hidden",e)}function Qe(){document.querySelector("main").requestFullscreen()}if(typeof window<"u"){Be().catch(t=>{console.error(t),document.querySelector(".content").textContent=t.toString()}),N(),window.addEventListener("gamepadconnected",N),window.addEventListener("gamepaddisconnected",N);let e=document.createElement("button");e.textContent="Fullscreen",e.classList.add("panel-button"),e.addEventListener("click",Qe),document.addEventListener("DOMContentLoaded",()=>{document.querySelector(".panel-buttons").append(e)})}})();
//# sourceMappingURL=main.js.map
